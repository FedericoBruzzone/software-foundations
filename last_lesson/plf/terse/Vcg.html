<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Vcg</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/plf.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="common/slides.js"></script>
<link href="common/css/slides.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 2: Programming Language Foundations</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
   <li class='section_name'><a href='deps.html'>Roadmap</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Vcg</h1>


<div class="doc">
<a id="lab109"></a><h1 class="section">Verification Condition Generation</h1>

<div class="paragraph"> </div>

 Consider this set of rules for Hoare Logic:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">P <span class="nowrap"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span></span> Q[X <span class="nowrap"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>&#x22A2;</span><span style='font-size:90%;'>&gt;</span></span></span></span></span> a]</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_asg_conseq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P<span style='letter-spacing:-.4em;'>}</span>} X:=a <span style='letter-spacing:-.4em;'>{</span>{Q<span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">P <span class="nowrap"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span></span> Q</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_skip_conseq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{ P <span style='letter-spacing:-.4em;'>}</span>} skip <span style='letter-spacing:-.4em;'>{</span>{ Q <span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{ P <span style='letter-spacing:-.4em;'>}</span>} c<sub>1</sub> <span style='letter-spacing:-.4em;'>{</span>{ Q <span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{ Q <span style='letter-spacing:-.4em;'>}</span>} c<sub>2</sub> <span style='letter-spacing:-.4em;'>{</span>{ R <span style='letter-spacing:-.4em;'>}</span>}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{ P <span style='letter-spacing:-.4em;'>}</span>} c<sub>1</sub>;c<sub>2</sub> <span style='letter-spacing:-.4em;'>{</span>{ R <span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P /\  b<span style='letter-spacing:-.4em;'>}</span>} c<sub>1</sub> <span style='letter-spacing:-.4em;'>{</span>{Q<span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P /\ ~b<span style='letter-spacing:-.4em;'>}</span>} c<sub>2</sub> <span style='letter-spacing:-.4em;'>{</span>{Q<span style='letter-spacing:-.4em;'>}</span>}</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_if) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P<span style='letter-spacing:-.4em;'>}</span>} if b then c<sub>1</sub> else c<sub>2</sub> end <span style='letter-spacing:-.4em;'>{</span>{Q<span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P /\ b<span style='letter-spacing:-.4em;'>}</span>} c <span style='letter-spacing:-.4em;'>{</span>{P<span style='letter-spacing:-.4em;'>}</span>} (P /\ ~b) <span class="nowrap"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span></span> Q</td>
  <td class="infrulenamecol" rowspan="3">
    (hoare_while_conseq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule"><span style='letter-spacing:-.4em;'>{</span>{P<span style='letter-spacing:-.4em;'>}</span>} while b do c end <span style='letter-spacing:-.4em;'>{</span>{Q<span style='letter-spacing:-.4em;'>}</span>}</td>
  <td></td>
</tr>
</table></center> 
<div class="paragraph"> </div>

<a id="lab110"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

<ul class="doclist">
<li> We have a <i>syntax</i> directed proof system and each backward rule

</li>
</ul>
application creates new subgoals for the subcommands.  The
construction of the skeleton of this proof tree is completely
automatic.

<div class="paragraph"> </div>

<ul class="doclist">
<li> The consequence rule is built into the derived rules and is not

</li>
</ul>
required anymore. This is crucial: the consequence rule destroys
syntax directedness because it can be applied at any point.

<div class="paragraph"> </div>

<ul class="doclist">
<li> When applying the sequence rule for <span class="inlinecode"><span class="id" title="var">c<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">c<sub>2</sub></span></span> <span class="inlinecode"></span> backwards we need to

</li>
</ul>
provide the intermediate assertion that occurs in the premises but not
the conclusion. It turns out that we can compute it by pulling the
final assertion back through <span class="inlinecode"><span class="id" title="var">c<sub>2</sub></span></span>.

<div class="paragraph"> </div>

There are two aspects that cannot be fully automated (or program
verification would be completely automatic, which is impossible):
<i>loop</i> invariants <i>must</i> be supplied explicitly, and the implications between
assertions in the premises of the derived rules must be proved
somehow.

<div class="paragraph"> </div>

In a nutshell, proving triples in Hoare logic amounts to <i>finding
invariants</i> and <i>proving assertions</i>.

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<a id="lab111"></a><h3 class="section"> </h3>
  We aim to reduce provability in Hoare logic to provability in the
assertion language, i.e. Coq in our case. Given a triple <span class="inlinecode">{<span class="id" title="var">P</span>}</span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode">{<span class="id" title="var">Q</span>}</span>
that we want to prove, we show how to compute an assertion <span class="inlinecode"><span class="id" title="var">A</span></span> from it
such that <span class="inlinecode">{<span class="id" title="var">P</span></span> <span class="inlinecode">}</span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode">{<span class="id" title="var">Q</span>}</span> is provable iff <span class="inlinecode"><span class="id" title="var">A</span></span> is provable.

<div class="paragraph"> </div>

We call <span class="inlinecode"><span class="id" title="var">A</span></span> a <i>verification condition</i> and the function that computes <span class="inlinecode"><span class="id" title="var">A</span></span>
a verification condition generator or <i>VCG</i>. The advantage of working
with a VCG is that no knowledge of Hoare logic is required.

<div class="paragraph"> </div>

Summary:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <i>annotate</i> the program with assertions meant to hold at certain
  program points

<div class="paragraph"> </div>

  ==&gt; This needs understanding ("eureka") of how the program works

<div class="paragraph"> </div>


</li>
<li> <i>generate</i> a set of logical conditions (VCs) from annotated program

<div class="paragraph"> </div>

  ==&gt; This is automatic

<div class="paragraph"> </div>


</li>
<li> <i>prove</i> the VCs.

<div class="paragraph"> </div>

  ==&gt; This is a matter of theorem proving (undecidable in general).  
</li>
</ul>

<div class="paragraph"> </div>

<a id="lab112"></a><h2 class="section">Annotated commands</h2>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

An annotated command is a command with <i>assertions</i> embedded within
it.  This may vary from <i>full</i> decoration (every command has pre and
post conditions), to more economical ones.

<div class="paragraph"> </div>

 We choose the least invasive: we only annotate <span class="inlinecode"><span class="id" title="var">while</span></span> loops with
 their invariants.

<div class="paragraph"> </div>

Where do we get those invariants? Here, we take the easy way out: the
<i>user</i> will provide them. In general, we can appeal to techniques such
as <i>abstract interpretation, symbolic execution</i> and <i>machine
learning</i> to get suggestions.

<div class="paragraph"> </div>

We introduce a type <span class="inlinecode"><span class="id" title="var">acom</span></span> of annotated commands with the same syntax
as that of type <span class="inlinecode"><span class="id" title="var">com</span></span>, except that WHILE is annotated with an
assertion <span class="inlinecode"><span class="id" title="var">asn</span></span>. We gloss over notations for now.
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">acom</span> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">CSkip</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CAsgn</span> (<span class="id" title="var">x</span> : <span class="id" title="var">string</span>) (<span class="id" title="var">a</span> : <span class="id" title="var">aexp</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">CSeq</span> (<span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> : <span class="id" title="var">acom</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">CIf</span> (<span class="id" title="var">b</span> : <span class="id" title="var">bexp</span>) (<span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> : <span class="id" title="var">acom</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">CWhile</span> (<span class="id" title="var">inv</span> : <span class="id" title="var">Assertion</span>)(<span class="id" title="var">b</span> : <span class="id" title="var">bexp</span>) (<span class="id" title="var">c</span> : <span class="id" title="var">acom</span>).<br/>
</div>

<div class="doc">
<a id="lab113"></a><h3 class="section"> </h3>
 We can <span class="inlinecode"><span class="id" title="var">strip</span></span> invariants from <span class="inlinecode"><span class="id" title="var">acom</span></span> and recover our usual <span class="inlinecode"><span class="id" title="var">com</span></span>mmands:
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span>  <span class="id" title="var">strip</span> (<span class="id" title="var">acm</span> : <span class="id" title="var">acom</span>)  : <span class="id" title="var">com</span>  :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">acm</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">CSkip</span> ⇒  <span class="id" title="var">Imp.CSkip</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">CAsgn</span> <span class="id" title="var">x</span> <span class="id" title="var">e</span> ⇒  <span class="id" title="var">Imp.CAsgn</span> <span class="id" title="var">x</span> <span class="id" title="var">e</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">CSeq</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒  <span class="id" title="var">Imp.CSeq</span> (<span class="id" title="var">strip</span> <span class="id" title="var">c<sub>1</sub></span>) (<span class="id" title="var">strip</span> <span class="id" title="var">c<sub>2</sub></span>) <br/>
&nbsp;&nbsp;|<span class="id" title="var">CIf</span> <span class="id" title="var">b</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒  <span class="id" title="var">Imp.CIf</span> <span class="id" title="var">b</span> (<span class="id" title="var">strip</span> <span class="id" title="var">c<sub>1</sub></span>) (<span class="id" title="var">strip</span> <span class="id" title="var">c<sub>2</sub></span>)<br/>
&nbsp;&nbsp;|<span class="id" title="var">CWhile</span> <span class="id" title="var">_</span> <span class="id" title="var">b</span> <span class="id" title="var">c</span> ⇒  <span class="id" title="var">Imp.CWhile</span> <span class="id" title="var">b</span> (<span class="id" title="var">strip</span> <span class="id" title="var">c</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab114"></a><h3 class="section">Weakest Preconditions</h3>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

The weakest precondition of a command <span class="inlinecode"><span class="id" title="var">c</span></span> with postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span> is an
assertion <span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> s.t:

<div class="paragraph"> </div>

<ul class="doclist">
<li> it is a <i>precondition</i>: p{ wpre c Q } c { Q }] ;

</li>
<li>  it is the weakest: if <span class="inlinecode">{</span> <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode">}</span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode">{</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">}</span> then <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span></span> <span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

</li>
</ul>

<div class="paragraph"> </div>

Think of <span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as the assertion described by set of states <span class="inlinecode"><span class="id" title="var">st</span></span>
 such that for all <span class="inlinecode"><span class="id" title="var">st'</span></span>, if <span class="inlinecode"><span class="id" title="var">st</span></span> <span class="inlinecode">=[</span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode">]=&gt;</span> <span class="inlinecode"><span class="id" title="var">st'</span></span>, then <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">st'</span></span> holds.

<div class="paragraph"> </div>

<span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> are the necessary hypotheses for program <span class="inlinecode"><span class="id" title="var">c</span></span> to compute a result
that satisfies the postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span>.  Original intuition (Dijkstra,
1975): synthesizing the program c by refinement from its postcondition
<span class="inlinecode"><span class="id" title="var">Q</span></span>. Examples of possible preconditions:

<div class="paragraph"> </div>

<ul class="doclist">
<li> A useless (though valid) Hoare triple:

</li>
</ul>

<div class="paragraph"> </div>

<span class="inlinecode"></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">False</span></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">5</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"></span>

<div class="paragraph"> </div>

<ul class="doclist">
<li> A better precondition:

</li>
</ul>

<div class="paragraph"> </div>

<span class="inlinecode"></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">Y</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">4</span> <span class="inlinecode">∧</span> <span class="inlinecode"><span class="id" title="var">Z</span></span> <span class="inlinecode">=</span> <span class="inlinecode">0</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">5</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"></span>

<div class="paragraph"> </div>

<ul class="doclist">
<li> The <i>best</i>  (weakest) precondition:

</li>
</ul>

<div class="paragraph"> </div>

<span class="inlinecode"></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">Y</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">4</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">Y</span></span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{</span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">5</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"></span>

<div class="paragraph"> </div>

 
<div class="paragraph"> </div>

<a id="lab115"></a><h3 class="section"> </h3>

</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span>  <span class="id" title="var">wpre</span> (<span class="id" title="var">acm</span> : <span class="id" title="var">acom</span>) (<span class="id" title="var">Q</span>: <span class="id" title="var">Assertion</span>) : <span class="id" title="var">Assertion</span>  :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">acm</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CSkip</span> ⇒ <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CAsgn</span> <span class="id" title="var">x</span> <span class="id" title="var">e</span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">Q</span> [<span class="id" title="var">x</span> <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>&#x22A2;</span><span style='font-size:90%;'>&gt;</span></span></span></span> <span class="id" title="var">e</span>] <span class="id" title="var">st</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">CSeq</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒ <span class="id" title="var">wpre</span> <span class="id" title="var">c<sub>1</sub></span> (<span class="id" title="var">wpre</span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">CIf</span> <span class="id" title="var">b</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="keyword">if</span> <span class="id" title="var">beval</span>  <span class="id" title="var">st</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> <span class="id" title="var">wpre</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">Q</span> <span class="id" title="var">st</span> <span class="id" title="keyword">else</span> <span class="id" title="var">wpre</span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">Q</span> <span class="id" title="var">st</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">CWhile</span> <span class="id" title="var">inv</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">inv</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
In the case of <span class="inlinecode"><span class="id" title="var">while</span></span>, computing <span class="inlinecode"><span class="id" title="var">wpre</span></span> would not terminate. This is
why we have annotated programs and we just return the invariant. 
<div class="paragraph"> </div>

<a id="lab116"></a><h3 class="section">Some examples</h3>

<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">:=</span> <span class="inlinecode">1<span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">X</span></span> <span class="inlinecode">≤</span> <span class="inlinecode">10<span style='letter-spacing:-.4em;'>}</span>}</span> yields <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{1</span> <span class="inlinecode">≤</span> <span class="inlinecode">10<span style='letter-spacing:-.4em;'>}</span>}</span> 
</div>
<div class="code">
<span class="id" title="keyword">Compute</span> (<span class="id" title="var">wpre</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> 1) (<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> : <span class="id" title="var">state</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span>  ≤ 10 )).<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">wpre</span></span> <span class="inlinecode">(<span class="id" title="var">Z</span>:=</span> <span class="inlinecode"><span class="id" title="var">X</span>;</span> <span class="inlinecode"><span class="id" title="var">X</span>:=<span class="id" title="var">Y</span>;<span class="id" title="var">Y</span></span> <span class="inlinecode">:=<span class="id" title="var">Z</span>)</span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">X</span></span> <span class="inlinecode">≤<span class="id" title="var">Y</span><span style='letter-spacing:-.4em;'>}</span>}</span> yields <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">Y</span></span> <span class="inlinecode">≤</span> <span class="inlinecode"><span class="id" title="var">Z</span><span style='letter-spacing:-.4em;'>}</span>}</span>  
</div>
<div class="code">

<span class="id" title="keyword">Compute</span>  (<span class="id" title="var">wpre</span>           (<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">Z</span> <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> <span class="id" title="var">Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">Y</span> <span class="id" title="var">Z</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span> ≤ <span class="id" title="var">st</span> <span class="id" title="var">Y</span>)).<br/>
</div>

<div class="doc">
<a id="lab117"></a><h3 class="section">VC</h3>
 The function <span class="inlinecode"><span class="id" title="var">vc</span></span> is the actual VCG and returns a <span class="inlinecode"><span class="id" title="keyword">Prop</span></span>, <i>not</i> an assertion
and it is therefore independent of the state, using <span class="inlinecode"><span class="id" title="var">wpre</span></span> in the process.

<div class="paragraph"> </div>

It  generates for non-while constructs only trivial verification conditions (skip, assigment)
or the conjunction of the results of subcomputations (seq, if).
 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span>  <span class="id" title="var">vc</span> (<span class="id" title="var">acm</span> : <span class="id" title="var">acom</span>) (<span class="id" title="var">Q</span>: <span class="id" title="var">Assertion</span>) : <span class="id" title="keyword">Prop</span>  :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">acm</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CSkip</span> ⇒ <span class="id" title="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CAsgn</span> <span class="id" title="var">x</span> <span class="id" title="var">e</span> ⇒ <span class="id" title="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">CSeq</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒ (<span class="id" title="var">vc</span> <span class="id" title="var">c<sub>1</sub></span> (<span class="id" title="var">wpre</span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">Q</span>) ∧ <span class="id" title="var">vc</span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">CIf</span> <span class="id" title="var">_</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> ⇒ <span class="id" title="var">vc</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">Q</span>  ∧  <span class="id" title="var">vc</span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">Q</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">CWhile</span> <span class="id" title="var">inv</span> <span class="id" title="var">b</span> <span class="id" title="var">c</span> ⇒ (<span class="id" title="keyword">∀</span> <span class="id" title="var">s</span>, (<span class="id" title="var">inv</span> <span class="id" title="var">s</span> ∧ (<span class="id" title="var">beval</span> <span class="id" title="var">s</span> <span class="id" title="var">b</span> = <span class="id" title="var">true</span>) → <span class="id" title="var">wpre</span> <span class="id" title="var">c</span> <span class="id" title="var">inv</span> <span class="id" title="var">s</span>) ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">inv</span> <span class="id" title="var">s</span> ∧ <span class="id" title="var">beval</span> <span class="id" title="var">s</span> <span class="id" title="var">b</span> = <span class="id" title="var">false</span> → <span class="id" title="var">Q</span> <span class="id" title="var">s</span>))  ∧ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vc</span> <span class="id" title="var">c</span> <span class="id" title="var">inv</span>  <span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab118"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

For each <span class="inlinecode">{<span class="id" title="var">inv</span>}</span> <span class="inlinecode"><span class="id" title="var">while</span></span> <span class="inlinecode"><span class="id" title="var">b</span></span> <span class="inlinecode"><span class="id" title="tactic">do</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> the function <span class="inlinecode"><span class="id" title="var">vc</span></span> builds 3 proof obligations:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">inv</span></span> and <span class="inlinecode"><span class="id" title="var">b</span></span> together imply the precondition of the body of the loop, i.e. <span class="inlinecode"><span class="id" title="var">inv</span></span> is an invariant.

<div class="paragraph"> </div>


</li>
<li> At the end of the loop the postcondition holds.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" title="var">vc</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">inv</span></span>: recursively applies to any other <span class="inlinecode"><span class="id" title="var">while</span></span> in <span class="inlinecode"><span class="id" title="var">c</span></span>.

<div class="paragraph"> </div>

 
</li>
</ul>

<div class="paragraph"> </div>

<a id="lab119"></a><h3 class="section">Examples</h3>

<div class="paragraph"> </div>

  Consider this "reduce to zero" program:
<br/>
<span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">True</span>}<br/>
<span class="id" title="var">while</span> <span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">True</span><span style='letter-spacing:-.4em;'>}</span>} <span class="id" title="var">X</span> ≠ 0 <span class="id" title="tactic">do</span><br/>
&nbsp;&nbsp;<span class="id" title="var">X</span> := <span class="id" title="var">X</span> - 1<br/>
<span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">X</span> = 0<span style='letter-spacing:-.4em;'>}</span>}
</span> 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">reduce_to_zero</span> : <span class="id" title="var">acom</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">CWhile</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> ⇒ <span class="id" title="var">True</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">BNeq</span> <span class="id" title="var">X</span> <span class="id" title="var">O</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> (<span class="id" title="var">AMinus</span> <span class="id" title="var">X</span> 1)).<br/>
</div>

<div class="doc">
The post condition: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">reduce_to_zero_post</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span> = 0.<br/>
</div>

<div class="doc">
<a id="lab120"></a><h3 class="section"> </h3>

</div>
<div class="code">
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> (<span class="id" title="var">vc</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CWhile</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> ⇒ <span class="id" title="var">True</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">BNeq</span> <span class="id" title="var">X</span> <span class="id" title="var">O</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> (<span class="id" title="var">AMinus</span> <span class="id" title="var">X</span> (<span class="id" title="var">S</span> <span class="id" title="var">O</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span> = 0)).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;(forall&nbsp;s&nbsp;:&nbsp;state,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(True&nbsp;/\&nbsp;negb&nbsp;(s&nbsp;X&nbsp;=?&nbsp;0)&nbsp;=&nbsp;true&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((fun&nbsp;_&nbsp;:&nbsp;state&nbsp;=&gt;&nbsp;True)&nbsp;<span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>&#x22A2;</span><span style='font-size:90%;'>&gt;</span></span></span></span></span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode">-</span> <span class="inlinecode">1</span>)&nbsp;s)&nbsp;/\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(True&nbsp;/\&nbsp;negb&nbsp;(s&nbsp;X&nbsp;=?&nbsp;0)&nbsp;=&nbsp;false&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;s&nbsp;X&nbsp;=&nbsp;0))&nbsp;/\&nbsp;True*)</span><br/>
</div>

<div class="doc">
... which is true.
</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">reduce_to_zero_correct_vgc</span>:<br/>
&nbsp;&nbsp;<span class="id" title="var">vc</span> <span class="id" title="var">reduce_to_zero</span> <span class="id" title="var">reduce_to_zero_post</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">reduce_to_zero</span>, <span class="id" title="var">reduce_to_zero_post</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">verify_assn</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab121"></a><h2 class="section">Soundness</h2>

<div class="paragraph"> </div>

 Our VCG is <i>sound</i> w.r.t. Hoare logic.
This reduces the question " does <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">P</span></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>}</span>}</span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">Q</span><span style='letter-spacing:-.4em;'>}</span>}</span> hold?"  to the question "is
the verification condition true ?".

<div class="paragraph"> </div>

We can prove, by induction on <span class="inlinecode"><span class="id" title="var">c</span></span>, that if <span class="inlinecode"><span class="id" title="var">vc</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> holds, then
the Hoare triple where the precondition has been <i>computed</i> by <span class="inlinecode"><span class="id" title="var">wpre</span></span> is indeed valid.

<div class="paragraph"> </div>

In other terms, <span class="inlinecode"><span class="id" title="var">vc</span></span> is <i>sufficient</i> for validity
 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <span class="id" title="var">vc_sound</span>:<span class="id" title="keyword">∀</span> <span class="id" title="var">c</span> <span class="id" title="var">Q</span>, <span class="id" title="var">vc</span> <span class="id" title="var">c</span> <span class="id" title="var">Q</span> → <span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">wpre</span> <span class="id" title="var">c</span> <span class="id" title="var">Q</span><span style='letter-spacing:-.4em;'>}</span>} (<span class="id" title="var">strip</span> <span class="id" title="var">c</span>) <span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">Q</span><span style='letter-spacing:-.4em;'>}</span>}.<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">induction</span> <span class="id" title="var">c</span>; <span class="id" title="tactic">intros</span>;<span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>.<br/>
- <span class="id" title="tactic">apply</span> <span class="id" title="var">hoare_skip</span>.<br/>
- <span class="id" title="tactic">apply</span> <span class="id" title="var">hoare_asgn</span>.<br/>
- <span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_seq</span>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="comment">(*&nbsp;if&nbsp;*)</span><br/>
- <span class="id" title="tactic">apply</span> <span class="id" title="var">IHc1</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">IHc2</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>0</sub></span>. <span class="id" title="tactic">clear</span> <span class="id" title="var">IHc1</span>. <span class="id" title="tactic">clear</span> <span class="id" title="var">IHc2</span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">hoare_if</span>; <span class="id" title="tactic">unfold</span> <span class="id" title="var">bassertion</span>.<br/>
&nbsp;+ <span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_consequence_pre</span>. <span class="id" title="var">eassumption</span>.<br/>
&nbsp;<span class="id" title="tactic">unfold</span> "<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span>". <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">beval</span> <span class="id" title="var">st</span> <span class="id" title="var">b</span>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>1</sub></span>; <span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;+ <span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_consequence_pre</span>. <span class="id" title="var">eassumption</span>.<br/>
&nbsp;<span class="id" title="tactic">unfold</span> "<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span>". <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">beval</span> <span class="id" title="var">st</span> <span class="id" title="var">b</span>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>1</sub></span>; <span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
<span class="comment">(*&nbsp;while&nbsp;*)</span><br/>
- <span class="id" title="tactic">apply</span> <span class="id" title="var">IHc</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>0</sub></span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_while_conseq</span>;  <span class="id" title="tactic">unfold</span> <span class="id" title="var">bassertion</span>.<br/>
&nbsp;<span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_consequence_pre</span>. <span class="id" title="var">eassumption</span>.<br/>
&nbsp;+ <span class="id" title="tactic">unfold</span> "<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span>". <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">H</span> <span class="id" title="var">st</span>). <span class="id" title="tactic">auto</span>.<br/>
&nbsp;+  <span class="id" title="tactic">unfold</span> "<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span>". <span class="id" title="tactic">intros</span>.<br/>
&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">H</span> <span class="id" title="var">st</span>).<br/>
&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>3</sub></span>. <span class="id" title="var">verify_assn</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">vcgen</span> (<span class="id" title="var">P</span>: <span class="id" title="var">Assertion</span>) (<span class="id" title="var">a</span>: <span class="id" title="var">acom</span>) (<span class="id" title="var">Q</span>: <span class="id" title="var">Assertion</span>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">P</span> <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span><span style='letter-spacing:-.2em;'>></span>></span></span> (<span class="id" title="var">wpre</span> <span class="id" title="var">a</span> <span class="id" title="var">Q</span>) ∧ <span class="id" title="var">vc</span> <span class="id" title="var">a</span> <span class="id" title="var">Q</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Corollary</span> <span class="id" title="var">vcg_s</span>: <span class="id" title="keyword">∀</span> <span class="id" title="var">c</span> <span class="id" title="var">P</span> <span class="id" title="var">Q</span>, <br/>
&nbsp;&nbsp;<span class="id" title="var">vcgen</span> <span class="id" title="var">P</span> <span class="id" title="var">c</span> <span class="id" title="var">Q</span> → <span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">P</span><span style='letter-spacing:-.4em;'>}</span>} (<span class="id" title="var">strip</span> <span class="id" title="var">c</span>) <span style='letter-spacing:-.4em;'>{</span>{<span class="id" title="var">Q</span><span style='letter-spacing:-.4em;'>}</span>}.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="var">vcgen</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">c</span> <span class="id" title="var">P</span> <span class="id" title="var">Q</span> [<span class="id" title="var">H<sub>1</sub></span> <span class="id" title="var">H<sub>2</sub></span>].<br/>
<span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_consequence_pre</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">apply</span> <span class="id" title="var">vc_sound</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab122"></a><h3 class="section"> </h3>
 How about completeness? Is <span class="inlinecode"><span class="id" title="var">vc</span></span> a necessarily condition?

<div class="paragraph"> </div>

Certainly not: if <span class="inlinecode"><span class="id" title="var">c</span></span> is badly annotated, <span class="inlinecode">{<span class="id" title="var">wpre</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span>}</span> <span class="inlinecode"><span class="id" title="var">strip</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode">{<span class="id" title="var">Q</span>}</span> may
be provable but not <span class="inlinecode"><span class="id" title="var">vc</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">loopq</span> (<span class="id" title="var">Q</span>: <span class="id" title="var">Assertion</span>) := (<span class="id" title="var">CWhile</span> <span class="id" title="var">Q</span> <span class="id" title="var">BTrue</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> (<span class="id" title="var">ANum</span> 0))) .<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">l</span> := (<span class="id" title="var">Imp.CWhile</span>  <span class="id" title="var">BTrue</span> (<span class="id" title="var">Imp.CAsgn</span> <span class="id" title="var">X</span> (<span class="id" title="var">ANum</span> 0))).<br/>
</div>

<div class="doc">
This triple is valid 
</div>
<div class="code">
<span class="id" title="keyword">Goal</span>  <span class="id" title="var">valid_hoare_triple</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> ⇒ <span class="id" title="var">s</span> <span class="id" title="var">X</span> = 1) <span class="id" title="var">l</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">False</span>).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;<span class="id" title="tactic">eapply</span> <span class="id" title="var">hoare_consequence_pre</span>.<br/>
&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">valid_hoare_triple</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> ⇒ <span class="id" title="var">True</span>) <span class="id" title="var">l</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">False</span>)) <span class="id" title="keyword">as</span> <span class="id" title="var">lp</span>.<br/>
&nbsp;- <span class="id" title="tactic">unfold</span> <span class="id" title="var">l</span>.<br/>
&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">hoare_while_conseq</span>.<br/>
&nbsp;&nbsp;-- <span class="id" title="tactic">apply</span> <span class="id" title="var">hoare_asg_conseq</span>. <span class="id" title="var">verify_assn</span>.<br/>
&nbsp;&nbsp;-- <span class="id" title="var">verify_assn</span>.<br/>
&nbsp;- <span class="id" title="tactic">apply</span> <span class="id" title="var">lp</span>.<br/>
&nbsp;- <span class="id" title="var">verify_assn</span>.<br/>
&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
However, if we annotate it with a wrong loop invariant, it generates
an unprovable verification condition: 
</div>
<div class="code">
<span class="id" title="keyword">Goal</span> (<span class="id" title="var">vc</span> (<span class="id" title="var">loopq</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> ⇒ <span class="id" title="var">s</span> <span class="id" title="var">X</span> = 1)) (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">False</span>)).<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">loop</span>. <span class="id" title="tactic">simpl</span>. <span class="id" title="var">verify_assn</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;false*)</span><br/>
<span class="id" title="var">Admitted</span>.<br/>
</div>

<div class="doc">
We could prove that there is always an annotation that make
completeness work. We won't.  
<div class="paragraph"> </div>

<a id="lab123"></a><h3 class="section">Some additional examples of using the VGC</h3>

<div class="paragraph"> </div>

 For programs w/o loops, verifying the <span class="inlinecode"><span class="id" title="var">vc</span></span> is trivial. 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">swap_program</span> : <span class="id" title="var">acom</span>   :=<br/>
&nbsp;&nbsp;<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">Z</span> <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">X</span> <span class="id" title="var">Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">Y</span> <span class="id" title="var">Z</span>)).<br/><hr class='doublespaceincode'/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">swap_corr_v</span> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <span class="id" title="var">nat</span>), <br/>
&nbsp;&nbsp;<span class="id" title="var">vc</span><br/>
&nbsp;&nbsp;<span class="id" title="var">swap_program</span><br/>
&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span> = <span class="id" title="var">y</span> ∧ <span class="id" title="var">st</span> <span class="id" title="var">Y</span> = <span class="id" title="var">x</span>).<br/>
&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <span class="id" title="var">swap_program</span>. <span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">tauto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab124"></a><h3 class="section">Division</h3>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">R</span> : <span class="id" title="var">string</span> := "R".<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">Q</span> : <span class="id" title="var">string</span> := "Q".<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">div_inv</span> : <span class="id" title="var">Assertion</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">X</span> = <span class="id" title="var">st</span> <span class="id" title="var">R</span> + (<span class="id" title="var">st</span> <span class="id" title="var">Y</span> × <span class="id" title="var">st</span> <span class="id" title="var">Q</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">div</span> : <span class="id" title="var">acom</span> :=<br/>
&nbsp;<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">R</span> <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;(<span class="id" title="var">CSeq</span> (<span class="id" title="var">CAsgn</span> <span class="id" title="var">Q</span> <span class="id" title="var">O</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CWhile</span> <span class="id" title="var">div_inv</span> (<span class="id" title="var">BLe</span> <span class="id" title="var">Y</span> <span class="id" title="var">R</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CSeq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">R</span> (<span class="id" title="var">AMinus</span> <span class="id" title="var">R</span> <span class="id" title="var">Y</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CAsgn</span> <span class="id" title="var">Q</span> (<span class="id" title="var">APlus</span> <span class="id" title="var">Q</span> (<span class="id" title="var">S</span> <span class="id" title="var">O</span>)))))).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">div_post</span> :=<br/>
<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒ <span class="id" title="var">st</span> <span class="id" title="var">R</span> &lt; <span class="id" title="var">st</span> <span class="id" title="var">Y</span> ∧ <span class="id" title="var">div_inv</span> <span class="id" title="var">st</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">div_correct_vcg</span>: (<span class="id" title="var">vc</span> <span class="id" title="var">div</span> <span class="id" title="var">div_post</span>).<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="var">div</span>, <span class="id" title="var">div_post</span>,<span class="id" title="var">div_inv</span>. <span class="id" title="tactic">simpl</span>. <span class="id" title="var">verify_assn</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>